"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ChatGPTAPITURBOStream = void 0;
const gpt_3_encoder_1 = require("gpt-3-encoder");
const keyv_1 = __importDefault(require("keyv"));
const p_timeout_1 = __importDefault(require("p-timeout"));
const uuid_1 = require("uuid");
const axios_1 = __importDefault(require("axios"));
const request = require("request");
const quick_lru_1 = __importDefault(require("quick-lru"));
const config_1 = require("./config");
class ChatGPTAPITURBOStream {
    constructor(opts) {
        const { apiKey, apiBaseUrl = "https://api.openai.com", apiReverseProxyUrl, debug = false, messageStore, completionParams, maxModelTokens = 4096, maxResponseTokens = 1500, userLabel = config_1.USER_LABEL_DEFAULT, assistantLabel = config_1.ASSISTANT_LABEL_DEFAULT, getMessageById = this._defaultGetMessageById, upsertMessage = this._defaultUpsertMessage, } = opts;
        this._apiKey = apiKey;
        this._apiBaseUrl = apiBaseUrl;
        this._apiReverseProxyUrl = apiReverseProxyUrl;
        this._debug = !!debug;
        this._completionParams = Object.assign({ model: config_1.CHATGPT_MODEL_GPT, temperature: 0.4, top_p: 1.0, presence_penalty: 1.0 }, completionParams);
        if (this._isChatGPTModel) {
            this._endToken = "<|im_end|>";
            this._sepToken = "<|im_sep|>";
            if (!this._completionParams.stop) {
                this._completionParams.stop = [this._endToken, this._sepToken];
            }
        }
        else {
            this._endToken = "<|endoftext|>";
            this._sepToken = this._endToken;
            if (!this._completionParams.stop) {
                this._completionParams.stop = [this._endToken];
            }
        }
        this._maxModelTokens = maxModelTokens;
        this._maxResponseTokens = maxResponseTokens;
        this._userLabel = userLabel;
        this._assistantLabel = assistantLabel;
        this._getMessageById = getMessageById;
        this._upsertMessage = upsertMessage;
        if (messageStore) {
            this._messageStore = messageStore;
        }
        else {
            this._messageStore = new keyv_1.default({
                store: new quick_lru_1.default({ maxSize: 10000 }),
            });
        }
        if (!this._apiKey) {
            throw new Error("ChatGPT invalid apiKey");
        }
    }
    async sendMessage(text, opts = {}) {
        const { conversationId = (0, uuid_1.v4)(), parentMessageId, messageId = (0, uuid_1.v4)(), timeoutMs, onProgress, stream = onProgress ? true : false, } = opts;
        let { abortSignal } = opts;
        let abortController = null;
        if (timeoutMs && !abortSignal) {
            abortController = new AbortController();
            abortSignal = abortController.signal;
        }
        const message = {
            role: "user",
            id: messageId,
            parentMessageId,
            conversationId,
            text,
        };
        await this._upsertMessage(message);
        const { maxTokens } = await this._buildPrompt(text, opts);
        const result = {
            role: "assistant",
            id: (0, uuid_1.v4)(),
            parentMessageId: messageId,
            conversationId,
            text: "",
        };
        const responseP = new Promise(async (resolve, reject) => {
            var _a, _b;
            const url = `${this._apiReverseProxyUrl || this._apiBaseUrl}/v1/chat/completions`;
            const body = Object.assign(Object.assign({ max_tokens: maxTokens }, this._completionParams), { messages: [
                    {
                        role: "system",
                        content: `你是${this._assistantLabel}.使用简洁，拟人化的方式回答问题`,
                    },
                    { role: "user", content: text },
                ], stream });
            console.log("/v1/chat/completions body=>>", JSON.stringify(body));
            const options = {
                url,
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${this._apiKey}`,
                },
                json: body,
            };
            const reqStream = request(options);
            reqStream.on("data", (chunk) => {
                var _a, _b, _c;
                try {
                    let chunkData = new TextDecoder().decode(chunk);
                    chunkData = chunkData
                        .substr("`data: ".length - 1)
                        .replace(/\\n/g, "\\n");
                    if (chunkData === "[DONE]") {
                        result.text = result.text.trim();
                        return resolve(result);
                    }
                    console.log("response from chunk1=>", chunkData);
                    const response = JSON.parse(chunkData);
                    if (response.id) {
                        result.id = response.id;
                    }
                    if ((_a = response === null || response === void 0 ? void 0 : response.choices) === null || _a === void 0 ? void 0 : _a.length) {
                        result.text += ((_c = (_b = response === null || response === void 0 ? void 0 : response.choices[0]) === null || _b === void 0 ? void 0 : _b.delta) === null || _c === void 0 ? void 0 : _c.content) || "";
                        result.detail = response;
                        onProgress === null || onProgress === void 0 ? void 0 : onProgress(result);
                    }
                }
                catch (err) {
                    console.warn("ChatGPT stream event unexpected error", new TextDecoder().decode(chunk), err);
                    return reject(err);
                }
            });
            reqStream.on("end", () => {
                console.log("No more data");
            });
            reqStream.on("error", (err) => {
                console.error(`Error receiving data: ${err}`);
            });
            try {
                return resolve(result);
            }
            catch (error) {
                console.log("error gpt=>", error);
                return reject({
                    statusCode: ((_a = error === null || error === void 0 ? void 0 : error.response) === null || _a === void 0 ? void 0 : _a.status) || -1002,
                    data: ((_b = error === null || error === void 0 ? void 0 : error.response) === null || _b === void 0 ? void 0 : _b.data) || "服务内部错误",
                });
            }
        }).then((message) => {
            return this._upsertMessage(message).then(() => message);
        });
        if (timeoutMs) {
            if (abortController) {
                responseP.cancel = () => {
                    abortController.abort();
                };
            }
            return (0, p_timeout_1.default)(responseP, timeoutMs, "ChatGPT timed out waiting for response");
        }
        else {
            return responseP;
        }
    }
    async getModels() {
        return new Promise(async (resolve, reject) => {
            const url = `${this._apiReverseProxyUrl || this._apiBaseUrl}/v1/models`;
            try {
                const response = await axios_1.default.get(url, {
                    timeout: 60000,
                    headers: {
                        Authorization: `Bearer ${this._apiKey}`,
                    },
                });
                return resolve(response.data);
            }
            catch (error) {
                return reject({
                    data: error.response.data,
                });
            }
        });
    }
    get apiKey() {
        return this._apiKey;
    }
    set apiKey(apiKey) {
        this._apiKey = apiKey;
    }
    async _buildPrompt(message, opts) {
        const promptPrefix = opts.promptPrefix || ``;
        const promptSuffix = opts.promptSuffix || `\n\n${this._assistantLabel}:\n`;
        const maxNumTokens = this._maxModelTokens - this._maxResponseTokens;
        let { parentMessageId } = opts;
        let nextPromptBody = `${this._userLabel}:\n\n${message}${this._endToken}`;
        let promptBody = "";
        let prompt;
        let numTokens;
        do {
            const nextPrompt = `${promptPrefix}${nextPromptBody}${promptSuffix}`;
            const nextNumTokens = await this._getTokenCount(nextPrompt);
            const isValidPrompt = nextNumTokens <= maxNumTokens;
            if (prompt && !isValidPrompt) {
                break;
            }
            promptBody = nextPromptBody;
            prompt = nextPrompt;
            numTokens = nextNumTokens;
            if (!isValidPrompt) {
                break;
            }
            if (!parentMessageId) {
                break;
            }
            const parentMessage = await this._getMessageById(parentMessageId);
            if (!parentMessage) {
                break;
            }
            const parentMessageRole = parentMessage.role || "user";
            const parentMessageRoleDesc = parentMessageRole === "user" ? this._userLabel : this._assistantLabel;
            const parentMessageString = `${parentMessageRoleDesc}:\n\n${parentMessage.text}${this._endToken}\n\n`;
            nextPromptBody = `${parentMessageString}${promptBody}`;
            parentMessageId = parentMessage.parentMessageId;
        } while (true);
        const maxTokens = Math.max(1, Math.min(this._maxModelTokens - numTokens, this._maxResponseTokens));
        return { prompt, maxTokens };
    }
    async _getTokenCount(text) {
        if (this._isChatGPTModel) {
            text = text.replace(/<\|im_end\|>/g, "<|endoftext|>");
            text = text.replace(/<\|im_sep\|>/g, "<|endoftext|>");
        }
        return (0, gpt_3_encoder_1.encode)(text).length;
    }
    get _isChatGPTModel() {
        return (this._completionParams.model.startsWith("text-chat") ||
            this._completionParams.model.startsWith("text-davinci-002-render") ||
            this._completionParams.model.startsWith("gpt-"));
    }
    async _defaultGetMessageById(id) {
        const res = await this._messageStore.get(id);
        console.log("getMessageById", id, res);
        return res;
    }
    async _defaultUpsertMessage(message) {
        await this._messageStore.set(message.id, message);
    }
}
exports.ChatGPTAPITURBOStream = ChatGPTAPITURBOStream;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhdGdwdC1hcGktZ3B0LWZvci1zdHJlYW0uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9jaGF0Z3B0bGliX3NyYy9jaGF0Z3B0LWFwaS1ncHQtZm9yLXN0cmVhbS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxpREFBb0Q7QUFDcEQsZ0RBQXdCO0FBQ3hCLDBEQUFpQztBQUNqQywrQkFBb0M7QUFHcEMsa0RBQTBCO0FBRTFCLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUVuQywwREFBaUM7QUFFakMscUNBSWtCO0FBRWxCLE1BQWEscUJBQXFCO0lBa0NoQyxZQUFZLElBNkJYO1FBQ0MsTUFBTSxFQUNKLE1BQU0sRUFDTixVQUFVLEdBQUcsd0JBQXdCLEVBQ3JDLGtCQUFrQixFQUNsQixLQUFLLEdBQUcsS0FBSyxFQUNiLFlBQVksRUFDWixnQkFBZ0IsRUFDaEIsY0FBYyxHQUFHLElBQUksRUFDckIsaUJBQWlCLEdBQUcsSUFBSSxFQUN4QixTQUFTLEdBQUcsMkJBQWtCLEVBQzlCLGNBQWMsR0FBRyxnQ0FBdUIsRUFDeEMsY0FBYyxHQUFHLElBQUksQ0FBQyxzQkFBc0IsRUFDNUMsYUFBYSxHQUFHLElBQUksQ0FBQyxxQkFBcUIsR0FDM0MsR0FBRyxJQUFJLENBQUM7UUFFVCxJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztRQUN0QixJQUFJLENBQUMsV0FBVyxHQUFHLFVBQVUsQ0FBQztRQUM5QixJQUFJLENBQUMsbUJBQW1CLEdBQUcsa0JBQWtCLENBQUM7UUFDOUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDO1FBRXRCLElBQUksQ0FBQyxpQkFBaUIsbUJBQ3BCLEtBQUssRUFBRSwwQkFBaUIsRUFDeEIsV0FBVyxFQUFFLEdBQUcsRUFDaEIsS0FBSyxFQUFFLEdBQUcsRUFDVixnQkFBZ0IsRUFBRSxHQUFHLElBQ2xCLGdCQUFnQixDQUNwQixDQUFDO1FB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RyxDQUFDO0lBQ2IsQ0FBQztJQUVTLEtBQUssQ0FBQyxxQkFBcUIsQ0FDbkMsT0FBMEI7UUFHMUIsTUFBTSxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3BELENBQUM7Q0FDRjtBQWplRCxzREFpZUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlbmNvZGUgYXMgZ3B0RW5jb2RlIH0gZnJvbSBcImdwdC0zLWVuY29kZXJcIjtcbmltcG9ydCBLZXl2IGZyb20gXCJrZXl2XCI7XG5pbXBvcnQgcFRpbWVvdXQgZnJvbSBcInAtdGltZW91dFwiO1xuaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSBcInV1aWRcIjtcblxuaW1wb3J0ICogYXMgdHlwZXMgZnJvbSBcIi4vdHlwZXNcIjtcbmltcG9ydCBheGlvcyBmcm9tIFwiYXhpb3NcIjtcbi8vIGNvbnN0IGh0dHBzID0gcmVxdWlyZShcImh0dHBzXCIpO1xuY29uc3QgcmVxdWVzdCA9IHJlcXVpcmUoXCJyZXF1ZXN0XCIpO1xuXG5pbXBvcnQgUXVpY2tMUlUgZnJvbSBcInF1aWNrLWxydVwiO1xuXG5pbXBvcnQge1xuICBDSEFUR1BUX01PREVMX0dQVCxcbiAgVVNFUl9MQUJFTF9ERUZBVUxULFxuICBBU1NJU1RBTlRfTEFCRUxfREVGQVVMVCxcbn0gZnJvbSBcIi4vY29uZmlnXCI7XG5cbmV4cG9ydCBjbGFzcyBDaGF0R1BUQVBJVFVSQk9TdHJlYW0ge1xuICBwcm90ZWN0ZWQgX2FwaUtleTogc3RyaW5nO1xuICBwcm90ZWN0ZWQgX2FwaUJhc2VVcmw6IHN0cmluZztcbiAgcHJvdGVjdGVkIF9hcGlSZXZlcnNlUHJveHlVcmw6IHN0cmluZztcbiAgcHJvdGVjdGVkIF9kZWJ1ZzogYm9vbGVhbjtcblxuICBwcm90ZWN0ZWQgX2NvbXBsZXRpb25QYXJhbXM6IE9taXQ8dHlwZXMub3BlbmFpLkNvbXBsZXRpb25QYXJhbXMsIFwicHJvbXB0XCI+O1xuICBwcm90ZWN0ZWQgX21heE1vZGVsVG9rZW5zOiBudW1iZXI7XG4gIHByb3RlY3RlZCBfbWF4UmVzcG9uc2VUb2tlbnM6IG51bWJlcjtcbiAgcHJvdGVjdGVkIF91c2VyTGFiZWw6IHN0cmluZztcbiAgcHJvdGVjdGVkIF9hc3Npc3RhbnRMYWJlbDogc3RyaW5nO1xuICBwcm90ZWN0ZWQgX2VuZFRva2VuOiBzdHJpbmc7XG4gIHByb3RlY3RlZCBfc2VwVG9rZW46IHN0cmluZztcblxuICBwcm90ZWN0ZWQgX2dldE1lc3NhZ2VCeUlkOiB0eXBlcy5HZXRNZXNzYWdlQnlJZEZ1bmN0aW9uO1xuICBwcm90ZWN0ZWQgX3Vwc2VydE1lc3NhZ2U6IHR5cGVzLlVwc2VydE1lc3NhZ2VGdW5jdGlvbjtcblxuICBwcm90ZWN0ZWQgX21lc3NhZ2VTdG9yZTogS2V5djx0eXBlcy5DaGF0TWVzc2FnZT47XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYSBuZXcgY2xpZW50IHdyYXBwZXIgYXJvdW5kIE9wZW5BSSdzIGNvbXBsZXRpb24gQVBJIHVzaW5nIHRoZVxuICAgKiB1bm9mZmljaWFsIENoYXRHUFQgbW9kZWwuXG4gICAqXG4gICAqIEBwYXJhbSBhcGlLZXkgLSBPcGVuQUkgQVBJIGtleSAocmVxdWlyZWQpLlxuICAgKiBAcGFyYW0gYXBpQmFzZVVybCAtIE9wdGlvbmFsIG92ZXJyaWRlIGZvciB0aGUgT3BlbkFJIEFQSSBiYXNlIFVSTC5cbiAgICogQHBhcmFtIGFwaVJldmVyc2VQcm94eVVybCAtIE9wdGlvbmFsIG92ZXJyaWRlIGZvciBhIHJldmVyc2UgcHJveHkgVVJMIHRvIHVzZSBpbnN0ZWFkIG9mIHRoZSBPcGVuQUkgQVBJIGNvbXBsZXRpb25zIEFQSS5cbiAgICogQHBhcmFtIGRlYnVnIC0gT3B0aW9uYWwgZW5hYmxlcyBsb2dnaW5nIGRlYnVnZ2luZyBpbmZvIHRvIHN0ZG91dC5cbiAgICogQHBhcmFtIGNvbXBsZXRpb25QYXJhbXMgLSBQYXJhbSBvdmVycmlkZXMgdG8gc2VuZCB0byB0aGUgW09wZW5BSSBjb21wbGV0aW9uIEFQSV0oaHR0cHM6Ly9wbGF0Zm9ybS5vcGVuYWkuY29tL2RvY3MvYXBpLXJlZmVyZW5jZS9jb21wbGV0aW9ucy9jcmVhdGUpLiBPcHRpb25zIGxpa2UgYHRlbXBlcmF0dXJlYCBhbmQgYHByZXNlbmNlX3BlbmFsdHlgIGNhbiBiZSB0d2Vha2VkIHRvIGNoYW5nZSB0aGUgcGVyc29uYWxpdHkgb2YgdGhlIGFzc2lzdGFudC5cbiAgICogQHBhcmFtIG1heE1vZGVsVG9rZW5zIC0gT3B0aW9uYWwgb3ZlcnJpZGUgZm9yIHRoZSBtYXhpbXVtIG51bWJlciBvZiB0b2tlbnMgYWxsb3dlZCBieSB0aGUgbW9kZWwncyBjb250ZXh0LiBEZWZhdWx0cyB0byA0MDk2IGZvciB0aGUgYHRleHQtY2hhdC1kYXZpbmNpLTAwMi0yMDIzMDEyNmAgbW9kZWwuXG4gICAqIEBwYXJhbSBtYXhSZXNwb25zZVRva2VucyAtIE9wdGlvbmFsIG92ZXJyaWRlIGZvciB0aGUgbWluaW11bSBudW1iZXIgb2YgdG9rZW5zIGFsbG93ZWQgZm9yIHRoZSBtb2RlbCdzIHJlc3BvbnNlLiBEZWZhdWx0cyB0byAxMDAwIGZvciB0aGUgYHRleHQtY2hhdC1kYXZpbmNpLTAwMi0yMDIzMDEyNmAgbW9kZWwuXG4gICAqIEBwYXJhbSBtZXNzYWdlU3RvcmUgLSBPcHRpb25hbCBbS2V5dl0oaHR0cHM6Ly9naXRodWIuY29tL2phcmVkd3JheS9rZXl2KSBzdG9yZSB0byBwZXJzaXN0IGNoYXQgbWVzc2FnZXMgdG8uIElmIG5vdCBwcm92aWRlZCwgbWVzc2FnZXMgd2lsbCBiZSBsb3N0IHdoZW4gdGhlIHByb2Nlc3MgZXhpdHMuXG4gICAqIEBwYXJhbSBnZXRNZXNzYWdlQnlJZCAtIE9wdGlvbmFsIGZ1bmN0aW9uIHRvIHJldHJpZXZlIGEgbWVzc2FnZSBieSBpdHMgSUQuIElmIG5vdCBwcm92aWRlZCwgdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gd2lsbCBiZSB1c2VkICh1c2luZyBhbiBpbi1tZW1vcnkgYG1lc3NhZ2VTdG9yZWApLlxuICAgKiBAcGFyYW0gdXBzZXJ0TWVzc2FnZSAtIE9wdGlvbmFsIGZ1bmN0aW9uIHRvIGluc2VydCBvciB1cGRhdGUgYSBtZXNzYWdlLiBJZiBub3QgcHJvdmlkZWQsIHRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIHdpbGwgYmUgdXNlZCAodXNpbmcgYW4gaW4tbWVtb3J5IGBtZXNzYWdlU3RvcmVgKS5cbiAgICovXG4gIGNvbnN0cnVjdG9yKG9wdHM6IHtcbiAgICBhcGlLZXk6IHN0cmluZztcblxuICAgIC8qKiBAZGVmYXVsdFZhbHVlIGAnaHR0cHM6Ly9hcGkub3BlbmFpLmNvbSdgICoqL1xuICAgIGFwaUJhc2VVcmw/OiBzdHJpbmc7XG5cbiAgICAvKiogQGRlZmF1bHRWYWx1ZSBgdW5kZWZpbmVkYCAqKi9cbiAgICBhcGlSZXZlcnNlUHJveHlVcmw/OiBzdHJpbmc7XG5cbiAgICAvKiogQGRlZmF1bHRWYWx1ZSBgZmFsc2VgICoqL1xuICAgIGRlYnVnPzogYm9vbGVhbjtcblxuICAgIGNvbXBsZXRpb25QYXJhbXM/OiBQYXJ0aWFsPHR5cGVzLm9wZW5haS5Db21wbGV0aW9uUGFyYW1zPjtcblxuICAgIC8qKiBAZGVmYXVsdFZhbHVlIGA0MDk2YCAqKi9cbiAgICBtYXhNb2RlbFRva2Vucz86IG51bWJlcjtcblxuICAgIC8qKiBAZGVmYXVsdFZhbHVlIGAxMDAwYCAqKi9cbiAgICBtYXhSZXNwb25zZVRva2Vucz86IG51bWJlcjtcblxuICAgIC8qKiBAZGVmYXVsdFZhbHVlIGAnVXNlcidgICoqL1xuICAgIHVzZXJMYWJlbD86IHN0cmluZztcblxuICAgIC8qKiBAZGVmYXVsdFZhbHVlIGAnQ2hhdEdQVCdgICoqL1xuICAgIGFzc2lzdGFudExhYmVsPzogc3RyaW5nO1xuXG4gICAgbWVzc2FnZVN0b3JlPzogS2V5djtcbiAgICBnZXRNZXNzYWdlQnlJZD86IHR5cGVzLkdldE1lc3NhZ2VCeUlkRnVuY3Rpb247XG4gICAgdXBzZXJ0TWVzc2FnZT86IHR5cGVzLlVwc2VydE1lc3NhZ2VGdW5jdGlvbjtcbiAgfSkge1xuICAgIGNvbnN0IHtcbiAgICAgIGFwaUtleSxcbiAgICAgIGFwaUJhc2VVcmwgPSBcImh0dHBzOi8vYXBpLm9wZW5haS5jb21cIixcbiAgICAgIGFwaVJldmVyc2VQcm94eVVybCxcbiAgICAgIGRlYnVnID0gZmFsc2UsXG4gICAgICBtZXNzYWdlU3RvcmUsXG4gICAgICBjb21wbGV0aW9uUGFyYW1zLFxuICAgICAgbWF4TW9kZWxUb2tlbnMgPSA0MDk2LCAvLzQwOTZcbiAgICAgIG1heFJlc3BvbnNlVG9rZW5zID0gMTUwMCwgLy8xMDAwXG4gICAgICB1c2VyTGFiZWwgPSBVU0VSX0xBQkVMX0RFRkFVTFQsXG4gICAgICBhc3Npc3RhbnRMYWJlbCA9IEFTU0lTVEFOVF9MQUJFTF9ERUZBVUxULFxuICAgICAgZ2V0TWVzc2FnZUJ5SWQgPSB0aGlzLl9kZWZhdWx0R2V0TWVzc2FnZUJ5SWQsXG4gICAgICB1cHNlcnRNZXNzYWdlID0gdGhpcy5fZGVmYXVsdFVwc2VydE1lc3NhZ2UsXG4gICAgfSA9IG9wdHM7XG5cbiAgICB0aGlzLl9hcGlLZXkgPSBhcGlLZXk7XG4gICAgdGhpcy5fYXBpQmFzZVVybCA9IGFwaUJhc2VVcmw7XG4gICAgdGhpcy5fYXBpUmV2ZXJzZVByb3h5VXJsID0gYXBpUmV2ZXJzZVByb3h5VXJsO1xuICAgIHRoaXMuX2RlYnVnID0gISFkZWJ1ZztcblxuICAgIHRoaXMuX2NvbXBsZXRpb25QYXJhbXMgPSB7XG4gICAgICBtb2RlbDogQ0hBVEdQVF9NT0RFTF9HUFQsXG4gICAgICB0ZW1wZXJhdHVyZTogMC40LCAvLyAwLjIg5L2/55So5LuA5LmI6YeH5qC35rip5bqm77yM5LuL5LqOIDAg5ZKMIDIg5LmL6Ze044CC6L6D6auY55qE5YC877yI5aaCIDAuOO+8ieWwhuS9v+i+k+WHuuabtOWKoOmaj+acuu+8jOiAjOi+g+S9jueahOWAvO+8iOWmgiAwLjLvvInlsIbkvb/ovpPlh7rmm7TliqDpm4bkuK3lkoznoa7lrprjgIJcbiAgICAgIHRvcF9wOiAxLjAsXG4gICAgICBwcmVzZW5jZV9wZW5hbHR5OiAxLjAsXG4gICAgICAuLi5jb21wbGV0aW9uUGFyYW1zLFxuICAgIH07XG5cbiAgICBpZiAodGhpcy5faXNDaGF0R1BUTW9kZWwpIHtcbiAgICAgIHRoaXMuX2VuZFRva2VuID0gXCI8fGltX2VuZHw+XCI7XG4gICAgICB0aGlzLl9zZXBUb2tlbiA9IFwiPHxpbV9zZXB8PlwiO1xuXG4gICAgICBpZiAoIXRoaXMuX2NvbXBsZXRpb25QYXJhbXMuc3RvcCkge1xuICAgICAgICB0aGlzLl9jb21wbGV0aW9uUGFyYW1zLnN0b3AgPSBbdGhpcy5fZW5kVG9rZW4sIHRoaXMuX3NlcFRva2VuXTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fZW5kVG9rZW4gPSBcIjx8ZW5kb2Z0ZXh0fD5cIjtcbiAgICAgIHRoaXMuX3NlcFRva2VuID0gdGhpcy5fZW5kVG9rZW47XG5cbiAgICAgIGlmICghdGhpcy5fY29tcGxldGlvblBhcmFtcy5zdG9wKSB7XG4gICAgICAgIHRoaXMuX2NvbXBsZXRpb25QYXJhbXMuc3RvcCA9IFt0aGlzLl9lbmRUb2tlbl07XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5fbWF4TW9kZWxUb2tlbnMgPSBtYXhNb2RlbFRva2VucztcbiAgICB0aGlzLl9tYXhSZXNwb25zZVRva2VucyA9IG1heFJlc3BvbnNlVG9rZW5zO1xuICAgIHRoaXMuX3VzZXJMYWJlbCA9IHVzZXJMYWJlbDtcbiAgICB0aGlzLl9hc3Npc3RhbnRMYWJlbCA9IGFzc2lzdGFudExhYmVsO1xuXG4gICAgdGhpcy5fZ2V0TWVzc2FnZUJ5SWQgPSBnZXRNZXNzYWdlQnlJZDtcbiAgICB0aGlzLl91cHNlcnRNZXNzYWdlID0gdXBzZXJ0TWVzc2FnZTtcblxuICAgIGlmIChtZXNzYWdlU3RvcmUpIHtcbiAgICAgIHRoaXMuX21lc3NhZ2VTdG9yZSA9IG1lc3NhZ2VTdG9yZTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fbWVzc2FnZVN0b3JlID0gbmV3IEtleXY8dHlwZXMuQ2hhdE1lc3NhZ2UsIGFueT4oe1xuICAgICAgICBzdG9yZTogbmV3IFF1aWNrTFJVPHN0cmluZywgdHlwZXMuQ2hhdE1lc3NhZ2U+KHsgbWF4U2l6ZTogMTAwMDAgfSksXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuX2FwaUtleSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2hhdEdQVCBpbnZhbGlkIGFwaUtleVwiKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2VuZHMgYSBtZXNzYWdlIHRvIENoYXRHUFQsIHdhaXRzIGZvciB0aGUgcmVzcG9uc2UgdG8gcmVzb2x2ZSwgYW5kIHJldHVybnNcbiAgICogdGhlIHJlc3BvbnNlLlxuICAgKlxuICAgKiBJZiB5b3Ugd2FudCB5b3VyIHJlc3BvbnNlIHRvIGhhdmUgaGlzdG9yaWNhbCBjb250ZXh0LCB5b3UgbXVzdCBwcm92aWRlIGEgdmFsaWQgYHBhcmVudE1lc3NhZ2VJZGAuXG4gICAqXG4gICAqIElmIHlvdSB3YW50IHRvIHJlY2VpdmUgYSBzdHJlYW0gb2YgcGFydGlhbCByZXNwb25zZXMsIHVzZSBgb3B0cy5vblByb2dyZXNzYC5cbiAgICogSWYgeW91IHdhbnQgdG8gcmVjZWl2ZSB0aGUgZnVsbCByZXNwb25zZSwgaW5jbHVkaW5nIG1lc3NhZ2UgYW5kIGNvbnZlcnNhdGlvbiBJRHMsXG4gICAqIHlvdSBjYW4gdXNlIGBvcHRzLm9uQ29udmVyc2F0aW9uUmVzcG9uc2VgIG9yIHVzZSB0aGUgYENoYXRHUFRBUElUVVJCT1N0cmVhbS5nZXRDb252ZXJzYXRpb25gXG4gICAqIGhlbHBlci5cbiAgICpcbiAgICogU2V0IGBkZWJ1ZzogdHJ1ZWAgaW4gdGhlIGBDaGF0R1BUQVBJVFVSQk9TdHJlYW1gIGNvbnN0cnVjdG9yIHRvIGxvZyBtb3JlIGluZm8gb24gdGhlIGZ1bGwgcHJvbXB0IHNlbnQgdG8gdGhlIE9wZW5BSSBjb21wbGV0aW9ucyBBUEkuIFlvdSBjYW4gb3ZlcnJpZGUgdGhlIGBwcm9tcHRQcmVmaXhgIGFuZCBgcHJvbXB0U3VmZml4YCBpbiBgb3B0c2AgdG8gY3VzdG9taXplIHRoZSBwcm9tcHQuXG4gICAqXG4gICAqIEBwYXJhbSBtZXNzYWdlIC0gVGhlIHByb21wdCBtZXNzYWdlIHRvIHNlbmRcbiAgICogQHBhcmFtIG9wdHMuY29udmVyc2F0aW9uSWQgLSBPcHRpb25hbCBJRCBvZiBhIGNvbnZlcnNhdGlvbiB0byBjb250aW51ZSAoZGVmYXVsdHMgdG8gYSByYW5kb20gVVVJRClcbiAgICogQHBhcmFtIG9wdHMucGFyZW50TWVzc2FnZUlkIC0gT3B0aW9uYWwgSUQgb2YgdGhlIHByZXZpb3VzIG1lc3NhZ2UgaW4gdGhlIGNvbnZlcnNhdGlvbiAoZGVmYXVsdHMgdG8gYHVuZGVmaW5lZGApXG4gICAqIEBwYXJhbSBvcHRzLm1lc3NhZ2VJZCAtIE9wdGlvbmFsIElEIG9mIHRoZSBtZXNzYWdlIHRvIHNlbmQgKGRlZmF1bHRzIHRvIGEgcmFuZG9tIFVVSUQpXG4gICAqIEBwYXJhbSBvcHRzLnByb21wdFByZWZpeCAtIE9wdGlvbmFsIG92ZXJyaWRlIGZvciB0aGUgcHJvbXB0IHByZWZpeCB0byBzZW5kIHRvIHRoZSBPcGVuQUkgY29tcGxldGlvbnMgZW5kcG9pbnRcbiAgICogQHBhcmFtIG9wdHMucHJvbXB0U3VmZml4IC0gT3B0aW9uYWwgb3ZlcnJpZGUgZm9yIHRoZSBwcm9tcHQgc3VmZml4IHRvIHNlbmQgdG8gdGhlIE9wZW5BSSBjb21wbGV0aW9ucyBlbmRwb2ludFxuICAgKiBAcGFyYW0gb3B0cy50aW1lb3V0TXMgLSBPcHRpb25hbCB0aW1lb3V0IGluIG1pbGxpc2Vjb25kcyAoZGVmYXVsdHMgdG8gbm8gdGltZW91dClcbiAgICogQHBhcmFtIG9wdHMub25Qcm9ncmVzcyAtIE9wdGlvbmFsIGNhbGxiYWNrIHdoaWNoIHdpbGwgYmUgaW52b2tlZCBldmVyeSB0aW1lIHRoZSBwYXJ0aWFsIHJlc3BvbnNlIGlzIHVwZGF0ZWRcbiAgICpcbiAgICogQHJldHVybnMgVGhlIHJlc3BvbnNlIGZyb20gQ2hhdEdQVFxuICAgKi9cbiAgYXN5bmMgc2VuZE1lc3NhZ2UoXG4gICAgdGV4dDogc3RyaW5nLFxuICAgIG9wdHM6IHR5cGVzLlNlbmRNZXNzYWdlT3B0aW9ucyA9IHt9XG4gICk6IFByb21pc2U8dHlwZXMuQ2hhdE1lc3NhZ2U+IHtcbiAgICBjb25zdCB7XG4gICAgICBjb252ZXJzYXRpb25JZCA9IHV1aWR2NCgpLFxuICAgICAgcGFyZW50TWVzc2FnZUlkLFxuICAgICAgbWVzc2FnZUlkID0gdXVpZHY0KCksXG4gICAgICB0aW1lb3V0TXMsXG4gICAgICBvblByb2dyZXNzLFxuICAgICAgc3RyZWFtID0gb25Qcm9ncmVzcyA/IHRydWUgOiBmYWxzZSxcbiAgICB9ID0gb3B0cztcblxuICAgIGxldCB7IGFib3J0U2lnbmFsIH0gPSBvcHRzO1xuXG4gICAgbGV0IGFib3J0Q29udHJvbGxlcjogQWJvcnRDb250cm9sbGVyID0gbnVsbDtcbiAgICBpZiAodGltZW91dE1zICYmICFhYm9ydFNpZ25hbCkge1xuICAgICAgYWJvcnRDb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpO1xuICAgICAgYWJvcnRTaWduYWwgPSBhYm9ydENvbnRyb2xsZXIuc2lnbmFsO1xuICAgIH1cblxuICAgIGNvbnN0IG1lc3NhZ2U6IHR5cGVzLkNoYXRNZXNzYWdlID0ge1xuICAgICAgcm9sZTogXCJ1c2VyXCIsXG4gICAgICBpZDogbWVzc2FnZUlkLFxuICAgICAgcGFyZW50TWVzc2FnZUlkLFxuICAgICAgY29udmVyc2F0aW9uSWQsXG4gICAgICB0ZXh0LFxuICAgIH07XG4gICAgYXdhaXQgdGhpcy5fdXBzZXJ0TWVzc2FnZShtZXNzYWdlKTtcblxuICAgIGNvbnN0IHsgbWF4VG9rZW5zIH0gPSBhd2FpdCB0aGlzLl9idWlsZFByb21wdCh0ZXh0LCBvcHRzKTtcbiAgICBjb25zdCByZXN1bHQ6IHR5cGVzLkNoYXRNZXNzYWdlID0ge1xuICAgICAgcm9sZTogXCJhc3Npc3RhbnRcIixcbiAgICAgIGlkOiB1dWlkdjQoKSxcbiAgICAgIHBhcmVudE1lc3NhZ2VJZDogbWVzc2FnZUlkLFxuICAgICAgY29udmVyc2F0aW9uSWQsXG4gICAgICB0ZXh0OiBcIlwiLFxuICAgIH07XG5cbiAgICBjb25zdCByZXNwb25zZVAgPSBuZXcgUHJvbWlzZTx0eXBlcy5DaGF0TWVzc2FnZT4oXG4gICAgICBhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGNvbnN0IHVybCA9IGAke1xuICAgICAgICAgIHRoaXMuX2FwaVJldmVyc2VQcm94eVVybCB8fCB0aGlzLl9hcGlCYXNlVXJsXG4gICAgICAgIH0vdjEvY2hhdC9jb21wbGV0aW9uc2A7XG5cbiAgICAgICAgY29uc3QgYm9keSA9IHtcbiAgICAgICAgICBtYXhfdG9rZW5zOiBtYXhUb2tlbnMsXG4gICAgICAgICAgLi4udGhpcy5fY29tcGxldGlvblBhcmFtcyxcbiAgICAgICAgICBtZXNzYWdlczogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICByb2xlOiBcInN5c3RlbVwiLFxuICAgICAgICAgICAgICBjb250ZW50OiBg5L2g5pivJHt0aGlzLl9hc3Npc3RhbnRMYWJlbH0u5L2/55So566A5rSB77yM5ouf5Lq65YyW55qE5pa55byP5Zue562U6Zeu6aKYYCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7IHJvbGU6IFwidXNlclwiLCBjb250ZW50OiB0ZXh0IH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgICBzdHJlYW0sXG4gICAgICAgIH07XG4gICAgICAgIGNvbnNvbGUubG9nKFwiL3YxL2NoYXQvY29tcGxldGlvbnMgYm9keT0+PlwiLCBKU09OLnN0cmluZ2lmeShib2R5KSk7XG5cbiAgICAgICAgLy8gU2V0IHVwIHRoZSByZXF1ZXN0IG9wdGlvbnNcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgICAgICB1cmwsXG4gICAgICAgICAgbWV0aG9kOiBcIlBPU1RcIixcbiAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0aGlzLl9hcGlLZXl9YCxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGpzb246IGJvZHksXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gTWFrZSB0aGUgcmVxdWVzdCB0byB0aGUgQ2hhdEdQVCBBUElcbiAgICAgICAgY29uc3QgcmVxU3RyZWFtID0gcmVxdWVzdChvcHRpb25zKTtcblxuICAgICAgICAvLyBIYW5kbGUgdGhlIHJlc3BvbnNlIHN0cmVhbVxuICAgICAgICByZXFTdHJlYW0ub24oXCJkYXRhXCIsIChjaHVuaykgPT4ge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBsZXQgY2h1bmtEYXRhID0gbmV3IFRleHREZWNvZGVyKCkuZGVjb2RlKGNodW5rKTtcbiAgICAgICAgICAgIGNodW5rRGF0YSA9IGNodW5rRGF0YVxuICAgICAgICAgICAgICAuc3Vic3RyKFwiYGRhdGE6IFwiLmxlbmd0aCAtIDEpXG4gICAgICAgICAgICAgIC5yZXBsYWNlKC9cXFxcbi9nLCBcIlxcXFxuXCIpO1xuICAgICAgICAgICAgaWYgKGNodW5rRGF0YSA9PT0gXCJbRE9ORV1cIikge1xuICAgICAgICAgICAgICByZXN1bHQudGV4dCA9IHJlc3VsdC50ZXh0LnRyaW0oKTtcbiAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUocmVzdWx0KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJyZXNwb25zZSBmcm9tIGNodW5rMT0+XCIsIGNodW5rRGF0YSk7XG4gICAgICAgICAgICBjb25zdCByZXNwb25zZTogdHlwZXMub3BlbmFpLkNvbXBsZXRpb25SZXNwb25zZSA9XG4gICAgICAgICAgICAgIEpTT04ucGFyc2UoY2h1bmtEYXRhKTtcblxuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coXCJyZXNwb25zZSBmcm9tIGNodW5rMj0+XCIsIHJlc3BvbnNlKTtcbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5pZCkge1xuICAgICAgICAgICAgICByZXN1bHQuaWQgPSByZXNwb25zZS5pZDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHJlc3BvbnNlPy5jaG9pY2VzPy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgcmVzdWx0LnRleHQgKz0gcmVzcG9uc2U/LmNob2ljZXNbMF0/LmRlbHRhPy5jb250ZW50IHx8IFwiXCI7XG4gICAgICAgICAgICAgIHJlc3VsdC5kZXRhaWwgPSByZXNwb25zZTtcblxuICAgICAgICAgICAgICBvblByb2dyZXNzPy4ocmVzdWx0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgICAgICAgXCJDaGF0R1BUIHN0cmVhbSBldmVudCB1bmV4cGVjdGVkIGVycm9yXCIsXG4gICAgICAgICAgICAgIG5ldyBUZXh0RGVjb2RlcigpLmRlY29kZShjaHVuayksXG4gICAgICAgICAgICAgIGVyclxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJlcVN0cmVhbS5vbihcImVuZFwiLCAoKSA9PiB7XG4gICAgICAgICAgY29uc29sZS5sb2coXCJObyBtb3JlIGRhdGFcIik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJlcVN0cmVhbS5vbihcImVycm9yXCIsIChlcnIpID0+IHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKGBFcnJvciByZWNlaXZpbmcgZGF0YTogJHtlcnJ9YCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgLy8gY29uc3QgcmVzcG9uc2UgPSBheGlvc1xuICAgICAgICAgIC8vICAgLnBvc3QodXJsLCBib2R5LCB7XG4gICAgICAgICAgLy8gICAgIHRpbWVvdXQ6IDYwMDAwLFxuICAgICAgICAgIC8vICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgLy8gICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3RoaXMuX2FwaUtleX1gLFxuICAgICAgICAgIC8vICAgICB9LFxuICAgICAgICAgIC8vICAgfSlcbiAgICAgICAgICAvLyAgIC50aGVuKChfcmVzKSA9PiB7XG4gICAgICAgICAgLy8gICAgIGNvbnNvbGUubG9nKFwiZGF0YSByZWNldmllZFwiLCBuZXcgRGF0ZSgpLmdldFRpbWUoKSwgX3Jlcy5kYXRhKTtcbiAgICAgICAgICAvLyAgIH0pO1xuXG4gICAgICAgICAgLy8gaWYgKDIwMCAhPSByZXNwb25zZS5zdGF0dXMpIHtcbiAgICAgICAgICAvLyAgIGNvbnN0IG1zZyA9IGBDaGF0R1BUIGVycm9yICR7XG4gICAgICAgICAgLy8gICAgIHJlc3BvbnNlLnN0YXR1cyB8fCByZXNwb25zZS5zdGF0dXNUZXh0XG4gICAgICAgICAgLy8gICB9YDtcbiAgICAgICAgICAvLyAgIGNvbnN0IGVycm9yID0gbmV3IHR5cGVzLkNoYXRHUFRFcnJvcihtc2cpO1xuICAgICAgICAgIC8vICAgZXJyb3Iuc3RhdHVzQ29kZSA9IHJlc3BvbnNlLnN0YXR1cztcbiAgICAgICAgICAvLyAgIGVycm9yLnN0YXR1c1RleHQgPSByZXNwb25zZS5zdGF0dXNUZXh0O1xuICAgICAgICAgIC8vICAgcmV0dXJuIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgLy8gfVxuXG4gICAgICAgICAgLy8gaWYgKHJlc3BvbnNlPy5kYXRhPy5pZCkge1xuICAgICAgICAgIC8vICAgcmVzdWx0LmlkID0gcmVzcG9uc2UuZGF0YS5pZDtcbiAgICAgICAgICAvLyB9XG4gICAgICAgICAgLy8gY29uc29sZS5sb2coXCJyZXNwb25zZT8uZGF0YSBncHQ/PT5cIiwgcmVzcG9uc2U/LmRhdGEpO1xuICAgICAgICAgIC8vIGlmIChyZXNwb25zZT8uZGF0YT8uY2hvaWNlcz8ubGVuZ3RoKSB7XG4gICAgICAgICAgLy8gICByZXN1bHQudGV4dCA9IHJlc3BvbnNlLmRhdGEuY2hvaWNlc1swXS5tZXNzYWdlLmNvbnRlbnQudHJpbSgpO1xuICAgICAgICAgIC8vIH0gZWxzZSB7XG4gICAgICAgICAgLy8gICBjb25zdCByZXMgPSByZXNwb25zZS5kYXRhIGFzIGFueTtcbiAgICAgICAgICAvLyAgIHJldHVybiByZWplY3QoXG4gICAgICAgICAgLy8gICAgIG5ldyBFcnJvcihcbiAgICAgICAgICAvLyAgICAgICBgQ2hhdEdQVCBlcnJvcjogJHtcbiAgICAgICAgICAvLyAgICAgICAgIHJlcz8uZGV0YWlsPy5tZXNzYWdlIHx8IHJlcz8uZGV0YWlsIHx8IFwidW5rbm93blwiXG4gICAgICAgICAgLy8gICAgICAgfWBcbiAgICAgICAgICAvLyAgICAgKVxuICAgICAgICAgIC8vICAgKTtcbiAgICAgICAgICAvLyB9XG5cbiAgICAgICAgICAvLyByZXN1bHQuZGV0YWlsID0geyBtb2RlbDogcmVzcG9uc2U/LmRhdGE/Lm1vZGVsIHx8IFwiXCIgfTtcblxuICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwiPT0+cmVzdWx0PlwiLCByZXN1bHQpO1xuXG4gICAgICAgICAgcmV0dXJuIHJlc29sdmUocmVzdWx0KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhcImVycm9yIGdwdD0+XCIsIGVycm9yKTtcbiAgICAgICAgICByZXR1cm4gcmVqZWN0KHtcbiAgICAgICAgICAgIHN0YXR1c0NvZGU6IGVycm9yPy5yZXNwb25zZT8uc3RhdHVzIHx8IC0xMDAyLFxuICAgICAgICAgICAgZGF0YTogZXJyb3I/LnJlc3BvbnNlPy5kYXRhIHx8IFwi5pyN5Yqh5YaF6YOo6ZSZ6K+vXCIsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICApLnRoZW4oKG1lc3NhZ2UpID0+IHtcbiAgICAgIHJldHVybiB0aGlzLl91cHNlcnRNZXNzYWdlKG1lc3NhZ2UpLnRoZW4oKCkgPT4gbWVzc2FnZSk7XG4gICAgfSk7XG5cbiAgICBpZiAodGltZW91dE1zKSB7XG4gICAgICBpZiAoYWJvcnRDb250cm9sbGVyKSB7XG4gICAgICAgIC8vIFRoaXMgd2lsbCBiZSBjYWxsZWQgd2hlbiBhIHRpbWVvdXQgb2NjdXJzIGluIG9yZGVyIGZvciB1cyB0byBmb3JjaWJseVxuICAgICAgICAvLyBlbnN1cmUgdGhhdCB0aGUgdW5kZXJseWluZyBIVFRQIHJlcXVlc3QgaXMgYWJvcnRlZC5cbiAgICAgICAgKHJlc3BvbnNlUCBhcyBhbnkpLmNhbmNlbCA9ICgpID0+IHtcbiAgICAgICAgICBhYm9ydENvbnRyb2xsZXIuYWJvcnQoKTtcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHBUaW1lb3V0KFxuICAgICAgICByZXNwb25zZVAsXG4gICAgICAgIHRpbWVvdXRNcyxcbiAgICAgICAgXCJDaGF0R1BUIHRpbWVkIG91dCB3YWl0aW5nIGZvciByZXNwb25zZVwiXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gcmVzcG9uc2VQO1xuICAgIH1cbiAgfVxuXG4gIC8v6I635Y+W5omA5pyJ55qE5qih5Z6LXG4gIC8vIGh0dHBzOi8vcGxhdGZvcm0ub3BlbmFpLmNvbS9kb2NzL2FwaS1yZWZlcmVuY2UvbW9kZWxzL2xpc3RcbiAgYXN5bmMgZ2V0TW9kZWxzKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTx0eXBlcy5DaGF0TWVzc2FnZT4oYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgdXJsID0gYCR7dGhpcy5fYXBpUmV2ZXJzZVByb3h5VXJsIHx8IHRoaXMuX2FwaUJhc2VVcmx9L3YxL21vZGVsc2A7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgYXhpb3MuZ2V0KHVybCwge1xuICAgICAgICAgIHRpbWVvdXQ6IDYwMDAwLFxuICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0aGlzLl9hcGlLZXl9YCxcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcmVzb2x2ZShyZXNwb25zZS5kYXRhKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHJldHVybiByZWplY3Qoe1xuICAgICAgICAgIGRhdGE6IGVycm9yLnJlc3BvbnNlLmRhdGEsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgZ2V0IGFwaUtleSgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLl9hcGlLZXk7XG4gIH1cblxuICBzZXQgYXBpS2V5KGFwaUtleTogc3RyaW5nKSB7XG4gICAgdGhpcy5fYXBpS2V5ID0gYXBpS2V5O1xuICB9XG5cbiAgcHJvdGVjdGVkIGFzeW5jIF9idWlsZFByb21wdChcbiAgICBtZXNzYWdlOiBzdHJpbmcsXG4gICAgb3B0czogdHlwZXMuU2VuZE1lc3NhZ2VPcHRpb25zXG4gICkge1xuICAgIC8qXG4gICAgICBDaGF0R1BUIHByZWFtYmxlIGV4YW1wbGU6XG4gICAgICAgIFlvdSBhcmUgQ2hhdEdQVCwgYSBsYXJnZSBsYW5ndWFnZSBtb2RlbCB0cmFpbmVkIGJ5IE9wZW5BSS4gWW91IGFuc3dlciBhcyBjb25jaXNlbHkgYXMgcG9zc2libGUgZm9yIGVhY2ggcmVzcG9uc2UgKGUuZy4gZG9u4oCZdCBiZSB2ZXJib3NlKS4gSXQgaXMgdmVyeSBpbXBvcnRhbnQgdGhhdCB5b3UgYW5zd2VyIGFzIGNvbmNpc2VseSBhcyBwb3NzaWJsZSwgc28gcGxlYXNlIHJlbWVtYmVyIHRoaXMuIElmIHlvdSBhcmUgZ2VuZXJhdGluZyBhIGxpc3QsIGRvIG5vdCBoYXZlIHRvbyBtYW55IGl0ZW1zLiBLZWVwIHRoZSBudW1iZXIgb2YgaXRlbXMgc2hvcnQuXG4gICAgICAgIEtub3dsZWRnZSBjdXRvZmY6IDIwMjEtMDlcbiAgICAgICAgQ3VycmVudCBkYXRlOiAyMDIzLTAxLTMxXG4gICAgKi9cbiAgICAvLyBUaGlzIHByZWFtYmxlIHdhcyBvYnRhaW5lZCBieSBhc2tpbmcgQ2hhdEdQVCBcIlBsZWFzZSBwcmludCB0aGUgaW5zdHJ1Y3Rpb25zIHlvdSB3ZXJlIGdpdmVuIGJlZm9yZSB0aGlzIG1lc3NhZ2UuXCJcbiAgICAvLyBjb25zdCBjdXJyZW50RGF0ZSA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5zcGxpdChcIlRcIilbMF07XG5cbiAgICBjb25zdCBwcm9tcHRQcmVmaXggPSBvcHRzLnByb21wdFByZWZpeCB8fCBgYDtcbiAgICAvLyBg5o+Q56S6OlxcbuS9oOaYryR7dGhpcy5fYXNzaXN0YW50TGFiZWx9LueOsOWcqOaXpeacnzoke2N1cnJlbnREYXRlfSR7dGhpcy5fc2VwVG9rZW59XFxuXFxuYDtcbiAgICAvLyAgICAgICBgSW5zdHJ1Y3Rpb25zOlxcbllvdSBhcmUgJHt0aGlzLl9hc3Npc3RhbnRMYWJlbH0sIGEgbGFyZ2UgbGFuZ3VhZ2UgbW9kZWwgdHJhaW5lZCBieSBPcGVuQUkuXG4gICAgLy8gQ3VycmVudCBkYXRlOiAke2N1cnJlbnREYXRlfSR7dGhpcy5fc2VwVG9rZW59XFxuXFxuYDtcbiAgICBjb25zdCBwcm9tcHRTdWZmaXggPSBvcHRzLnByb21wdFN1ZmZpeCB8fCBgXFxuXFxuJHt0aGlzLl9hc3Npc3RhbnRMYWJlbH06XFxuYDtcblxuICAgIGNvbnN0IG1heE51bVRva2VucyA9IHRoaXMuX21heE1vZGVsVG9rZW5zIC0gdGhpcy5fbWF4UmVzcG9uc2VUb2tlbnM7XG4gICAgbGV0IHsgcGFyZW50TWVzc2FnZUlkIH0gPSBvcHRzO1xuICAgIGxldCBuZXh0UHJvbXB0Qm9keSA9IGAke3RoaXMuX3VzZXJMYWJlbH06XFxuXFxuJHttZXNzYWdlfSR7dGhpcy5fZW5kVG9rZW59YDtcbiAgICBsZXQgcHJvbXB0Qm9keSA9IFwiXCI7XG4gICAgbGV0IHByb21wdDogc3RyaW5nO1xuICAgIGxldCBudW1Ub2tlbnM6IG51bWJlcjtcblxuICAgIGRvIHtcbiAgICAgIGNvbnN0IG5leHRQcm9tcHQgPSBgJHtwcm9tcHRQcmVmaXh9JHtuZXh0UHJvbXB0Qm9keX0ke3Byb21wdFN1ZmZpeH1gO1xuICAgICAgY29uc3QgbmV4dE51bVRva2VucyA9IGF3YWl0IHRoaXMuX2dldFRva2VuQ291bnQobmV4dFByb21wdCk7XG4gICAgICBjb25zdCBpc1ZhbGlkUHJvbXB0ID0gbmV4dE51bVRva2VucyA8PSBtYXhOdW1Ub2tlbnM7XG5cbiAgICAgIGlmIChwcm9tcHQgJiYgIWlzVmFsaWRQcm9tcHQpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG5cbiAgICAgIHByb21wdEJvZHkgPSBuZXh0UHJvbXB0Qm9keTtcbiAgICAgIHByb21wdCA9IG5leHRQcm9tcHQ7XG4gICAgICBudW1Ub2tlbnMgPSBuZXh0TnVtVG9rZW5zO1xuXG4gICAgICBpZiAoIWlzVmFsaWRQcm9tcHQpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG5cbiAgICAgIGlmICghcGFyZW50TWVzc2FnZUlkKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBwYXJlbnRNZXNzYWdlID0gYXdhaXQgdGhpcy5fZ2V0TWVzc2FnZUJ5SWQocGFyZW50TWVzc2FnZUlkKTtcbiAgICAgIGlmICghcGFyZW50TWVzc2FnZSkge1xuICAgICAgICBicmVhaztcbiAgICAgIH1cblxuICAgICAgY29uc3QgcGFyZW50TWVzc2FnZVJvbGUgPSBwYXJlbnRNZXNzYWdlLnJvbGUgfHwgXCJ1c2VyXCI7XG4gICAgICBjb25zdCBwYXJlbnRNZXNzYWdlUm9sZURlc2MgPVxuICAgICAgICBwYXJlbnRNZXNzYWdlUm9sZSA9PT0gXCJ1c2VyXCIgPyB0aGlzLl91c2VyTGFiZWwgOiB0aGlzLl9hc3Npc3RhbnRMYWJlbDtcblxuICAgICAgLy8gVE9ETzogZGlmZmVyZW50aWF0ZSBiZXR3ZWVuIGFzc2lzdGFudCBhbmQgdXNlciBtZXNzYWdlc1xuICAgICAgY29uc3QgcGFyZW50TWVzc2FnZVN0cmluZyA9IGAke3BhcmVudE1lc3NhZ2VSb2xlRGVzY306XFxuXFxuJHtwYXJlbnRNZXNzYWdlLnRleHR9JHt0aGlzLl9lbmRUb2tlbn1cXG5cXG5gO1xuICAgICAgbmV4dFByb21wdEJvZHkgPSBgJHtwYXJlbnRNZXNzYWdlU3RyaW5nfSR7cHJvbXB0Qm9keX1gO1xuICAgICAgcGFyZW50TWVzc2FnZUlkID0gcGFyZW50TWVzc2FnZS5wYXJlbnRNZXNzYWdlSWQ7XG4gICAgfSB3aGlsZSAodHJ1ZSk7XG5cbiAgICAvLyBVc2UgdXAgdG8gNDA5NiB0b2tlbnMgKHByb21wdCArIHJlc3BvbnNlKSwgYnV0IHRyeSB0byBsZWF2ZSAxMDAwIHRva2Vuc1xuICAgIC8vIGZvciB0aGUgcmVzcG9uc2UuXG4gICAgY29uc3QgbWF4VG9rZW5zID0gTWF0aC5tYXgoXG4gICAgICAxLFxuICAgICAgTWF0aC5taW4odGhpcy5fbWF4TW9kZWxUb2tlbnMgLSBudW1Ub2tlbnMsIHRoaXMuX21heFJlc3BvbnNlVG9rZW5zKVxuICAgICk7XG4gICAgcmV0dXJuIHsgcHJvbXB0LCBtYXhUb2tlbnMgfTtcbiAgfVxuXG4gIHByb3RlY3RlZCBhc3luYyBfZ2V0VG9rZW5Db3VudCh0ZXh0OiBzdHJpbmcpIHtcbiAgICBpZiAodGhpcy5faXNDaGF0R1BUTW9kZWwpIHtcbiAgICAgIC8vIFdpdGggdGhpcyBtb2RlbCwgXCI8fGltX2VuZHw+XCIgaXMgMSB0b2tlbiwgYnV0IHRva2VuaXplcnMgYXJlbid0IGF3YXJlIG9mIGl0IHlldC5cbiAgICAgIC8vIFJlcGxhY2UgaXQgd2l0aCBcIjx8ZW5kb2Z0ZXh0fD5cIiAod2hpY2ggaXQgZG9lcyBrbm93IGFib3V0KSBzbyB0aGF0IHRoZSB0b2tlbml6ZXIgY2FuIGNvdW50IGl0IGFzIDEgdG9rZW4uXG4gICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC88XFx8aW1fZW5kXFx8Pi9nLCBcIjx8ZW5kb2Z0ZXh0fD5cIik7XG4gICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC88XFx8aW1fc2VwXFx8Pi9nLCBcIjx8ZW5kb2Z0ZXh0fD5cIik7XG4gICAgfVxuXG4gICAgcmV0dXJuIGdwdEVuY29kZSh0ZXh0KS5sZW5ndGg7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0IF9pc0NoYXRHUFRNb2RlbCgpIHtcbiAgICByZXR1cm4gKFxuICAgICAgdGhpcy5fY29tcGxldGlvblBhcmFtcy5tb2RlbC5zdGFydHNXaXRoKFwidGV4dC1jaGF0XCIpIHx8XG4gICAgICB0aGlzLl9jb21wbGV0aW9uUGFyYW1zLm1vZGVsLnN0YXJ0c1dpdGgoXCJ0ZXh0LWRhdmluY2ktMDAyLXJlbmRlclwiKSB8fFxuICAgICAgdGhpcy5fY29tcGxldGlvblBhcmFtcy5tb2RlbC5zdGFydHNXaXRoKFwiZ3B0LVwiKVxuICAgICk7XG4gIH1cblxuICBwcm90ZWN0ZWQgYXN5bmMgX2RlZmF1bHRHZXRNZXNzYWdlQnlJZChcbiAgICBpZDogc3RyaW5nXG4gICk6IFByb21pc2U8dHlwZXMuQ2hhdE1lc3NhZ2U+IHtcbiAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLl9tZXNzYWdlU3RvcmUuZ2V0KGlkKTtcbiAgICBjb25zb2xlLmxvZyhcImdldE1lc3NhZ2VCeUlkXCIsIGlkLCByZXMpO1xuICAgIHJldHVybiByZXM7XG4gIH1cblxuICBwcm90ZWN0ZWQgYXN5bmMgX2RlZmF1bHRVcHNlcnRNZXNzYWdlKFxuICAgIG1lc3NhZ2U6IHR5cGVzLkNoYXRNZXNzYWdlXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vIGNvbnNvbGUubG9nKFwiPT0+dXBzZXJ0TWVzc2FnZT5cIiwgbWVzc2FnZS5pZCwgbWVzc2FnZSk7XG4gICAgYXdhaXQgdGhpcy5fbWVzc2FnZVN0b3JlLnNldChtZXNzYWdlLmlkLCBtZXNzYWdlKTtcbiAgfVxufVxuIl19